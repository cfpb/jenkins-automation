# Examples

## Base Job Builder

```groovy
import jenkins.automation.builders.BaseJobBuilder

 BaseJobBuilder(
     name: "sample-job",
     description: "Description of your job",
     emails: ["foo@example.com","bar@example.com"]
).build(this)
```

## Checkmarx Security Job Builder

```groovy
import jenkins.automation.builders.CheckmarxSecurityJobBuilder

def groupId = "ac43cb0d-034d-4b1e-9bf5-e7c1c46f71d2"
def projectName ='sample-project'

new CheckmarxSecurityJobBuilder(
        name: "${projectName}-checkmarx",
        description: "Sample checkmarx security job",
        scanRepo: [[url: "https://github.com/cfpb/jenkins-automation"]],
        checkmarxConfig: [
            projectName: "${projectName}-checkmarx",
            groupId: "${groupId}",
            excludeFolders: ".git, build",
            comment: "Generated by Checkmarx job builder JAC",
            vulnerabilityThresholdEnabled: true,
            highThreshold: 4,
            mediumThreshold: 8,
            lowThreshold: 12,
        ],
).build(this)
```

### Checkmarx Security Job Builder with OSA

```groovy
import jenkins.automation.builders.BaseJobBuilder
import jenkins.automation.utils.CheckmarxUtils

def projectName = 'foo'
def groupId = 'ac43cb0d-034d-4b1e-9bf5-e7c1c46f71d2'
def osaCheckmarxConfig =  [
    projectName: "${projectName}-osa-checkmarx",
    groupId: "${groupId}",
    comment: 'Generated by Checkmarx job builder JAC',
    vulnerabilityThresholdEnabled: true,
    highThreshold: 1,
    mediumThreshold: 2,
    lowThreshold: 3,
    osaEnabled: true,
    osaHighThreshold: 1,
    osaMediumThreshold: 2,
    osaLowThreshold: 3,
]

new BaseJobBuilder(
        name: "${projectName}-osa-checkmarx",
        description: 'Sample checkmarx security job',
).build(this).with {
    scm {
        git {
            remote {
                url('https://github.com/champain/jenkins-automation')
            }
            branch('checkmarx_osa_fixes')
        }
    }

    steps {
        gradle {
            tasks('copyDependencies')
          }
    }

    CheckmarxUtils.checkmarxScan(delegate, osaCheckmarxConfig)
}

```

## BDD Security Job Builder

```groovy
import jenkins.automation.builders.BddSecurityJobBuilder

def projectName ='sample-project'
def bddSecurityRepo ="repo-to-scan'
new BddSecurityJobBuilder(
       name: "${projectName}-bdd-security-job",
       description: "Sample bdd security job",
       baseUrl: "http://google.com",
       bddSecurityRepo: "${bddSecurityRepo}",
       chromedriverPath: "\\/Users\\/sotoo\\/homebrew\\/bin\\/Chromedriver"
).build(this)
```

## Pipeline Builder

```groovy
import jenkins.automation.builders.PipelineJobBuilder

def script = """
    pipeline {
        agent { label 'master' }
        stages {
            stage('hello') {
                steps {
                    sh 'echo "Hello World"'
                }
            }
        }
    }
"""

new PipelineJobBuilder(
        name: 'Hello Pipeline With Script',
        description: 'This is a simple pipeline job',
        pipelineScript: script,
        sandboxFlag: false
).build(this).with {
    logRotator {
        numToKeep(365)
    }
}

new PipelineJobBuilder(
        name: 'Pipeline builder with stages',
        description: 'this is a simple pipeline job',
        stages: [[
                         stageName : 'First stage',
                         jobName   : 'Job 1',
                         parameters: "[[\$class: 'StringParameterValue', name: 'foo', value: 'bar']]"
                 ],
                 [
                         stageName: 'Second stage',
                         jobName  : 'Job 2',
                 ]]
).build(this)
.with {
    logRotator {
        numToKeep(365)
    }
}

```

## Multibranch Pipeline Builder using 'git' as branch source (instead of GitHub API)

```groovy
import jenkins.automation.builders.MultibranchPipelineJobBuilder

new MultibranchPipelineJobBuilder(
    name: "multi-branch-pipeline-git",
    description: "Sample Multibranch Pipeline Job using git as the branch source",
    branchSource: MultibranchPipelineJobBuilder.BranchSourceType.GIT,
    gitCredentials: "009c8c9d-3cf5-4b2a-89f3-286977cabddf",
    gitRemote: "https://github.com/OrlandoSoto/orlando-shared-libraries",
).build(this)
```

## Multibranch Pipeline Builder using a GitHub Enterprise API as branch source
```groovy
import jenkins.automation.builders.MultibranchPipelineJobBuilder

new MultibranchPipelineJobBuilder(
    name: "multi-branch-pipeline-github-enterprise",
    description: "Sample Multibranch Pipeline using the GitHub API as the branch source",
    branchSource: MultibranchPipelineJobBuilder.BranchSourceType.GITHUB,
    gitCredentials: "8fbdbaa0-d5ff-4acb-9e8f-27e49b77048a",
    ghOwner: "org-name",
    ghRepo: "repo-name",
    ghApiEndpoint: "https://github.example.com/api/v3",
    oldNumToKeep: 1
).build(this)
```

## JS Build Job

```groovy
import jenkins.automation.builders.JsJobBuilder

String basePath = 'JsJobSamples'
List developers = ['jane@example.com', 'joe@example.com']

def repos = [
        [name: 'jenkins-automation', url: "https://github.com/cfpb/jenkins-automation@2.0"],
        [name: 'collab', url: "https://github.com/cfpb/collab"]
        [name: 'other', url: "https://github.com/cfpb/jenkins-automation", disable_submodule: true]
]
folder(basePath) {
    description 'This example shows how to create jobs using Job builders.'
}

new JsJobBuilder(
        name: "$basePath/BuilderVsBuilders",
        description: 'An example using a job builder for a Javascript build jobs project',
        repos: repos,
        emails: developers,
        use_versions: true
).build(this)
```

## Salesforce Build Job

```groovy

import jenkins.automation.builders.SalesforceAntJobBuilder

List developers = ['jane@example.com', 'joe@example.com']

def repo = "https://github.com/cfpb/salesforce-automation"

new SalesforceAntJobBuilder(
        name: "example-salesforce-ant-job",
        description: 'An example using a job builder for a Salesforce Ant JobBuilder build jobs project.',
        repoUrl: repo,
        emails: developers,
        antTasks: ["retrieveUnpackaged"],
        antInstallerName:"ant-latest"
).build(this)

```

## Sauce On Demand job
```groovy
import jenkins.automation.builders.SauceConnectJobBuilder

def projectName ='foo'
new SauceConnectJobBuilder(
        name: "example-browser-test",
        description: "Sample Sauce on Demand job",
        emails: ['email1@server1.com', 'email2@server2.com'],
        sauceCredentialId: '1234',
        // Note that when using Gradle build sauceCredentialId does not get populated.
        // However, sauceCredentialId is correctly populated when built inside a Jenkins environment
        additionalOptions: "-v"
).build(this);
```

## Using MultiScm Utility


```groovy
import jenkins.automation.builders.BaseJobBuilder
import jenkins.automation.utils.ScmUtils

def repos = [
        [name: 'jenkins-automation', url: "https://github.com/cfpb/jenkins-automation@2.0"],
        [name: 'collab', url: "https://github.com/cfpb/collab"],
        [name: 'hubot-aws-cfpb', url: "https://github.com/cfpb/hubot-aws-cfpb", branch: "main"]
]
new BaseJobBuilder(
        name: "sample-job-with-multiscm",
        description: "A sample with multiple source control repositories",
).build(this).with {
    multiscm {
        ScmUtils.project_repos(delegate, repos, true)
    }
}
```

## Using the Git shallow clone utility


```groovy
import jenkins.automation.builders.BaseJobBuilder
import jenkins.automation.utils.ScmUtils

new BaseJobBuilder(
    name: "sample-job-with-git-shallow-clone",
    description: "A sample demonstrating a repo being git shallow-cloned",
).build(this).with {
    scm {
        ScmUtils.shallowGit(delegate, "https://github.com/cfpb/jenkins-automation", "feature-branch")
    }
}
```


## Customizing your job

### Determining the environment

```groovy
import jenkins.automation.utils.EnvironmentUtils

// In our Jenkinses, we name this variable "JAC_ENVIRONMENT" with values of "DEV", "STAGE", or "PROD"
// In your Jenkins, you can name the variable whatever you like; replace the variable you pass into
// EnvironmentUtils.getInstance(...) with your global variable name

def env = EnvironmentUtils.getInstance("${JAC_ENVIRONMENT}")
println "Environment is " + env.getEnv()

if (env.isDev()){
    // Do environment-specific things here
}

job('test') {
    steps {
        shell "echo ${env.getEnv()}"
    }
}

```

### Running a job on a schedule

```groovy
job('example') {
    triggers {
       cron("H/15 * * * *")
    }
}
```

### Including a [Jenkins Custom Tool](https://wiki.jenkins-ci.org/display/JENKINS/Custom+Tools+Plugin)

```groovy
job('example') {
    wrappers {
       customTools(['jq'])
    }
}
```

### Including variables in a shell step

```groovy
var variable_from_this_script = 'foo';

job('example') {
    steps {
       shell("""
          my_command \
             --my-arg ${variable_from_this_script} \
             --other-arg \${JENKINS_VARIABLE}
         """.stripIndent()
      )
    }
}
```

## Common Utils

### Defaults

```groovy
import jenkins.automation.utils.CommonUtils

job('example'){
    CommonUtils.addDefaults(delegate)
}
```


### Extended Email

```groovy
import jenkins.automation.utils.CommonUtils

job("example"){
    CommonUtils.addExtendedEmail(delegate, emails = 'foo@example.com, bar@example.com')
}

// override accepts emails as a list. Compatible with builders
job('example'){
     publishers {
        CommonUtils.addExtendedEmail(delegate, emails = ['foo@example.com', 'bar@example.com'])
    }
}

// Override default email triggers.
job('example'){
  publishers {
    CommonUtils.addExtendedEmail(delegate, emails, triggers=['statusChanged'])
   }
}

// Override default email pre-send script, by providing a groovy code
job('example'){
     publishers {    
        CommonUtils.addExtendedEmail(delegate, emails, triggers, sendToDevs, senToReq, includeCulprits, sendToRecipient, "cancel = true")
     }
}   

// Override default email pre-send script by providing path to the script file
job('example'){
     publishers {
        CommonUtils.addExtendedEmail(delegate, emails, triggers, sendToDevs, sendToReq, includeCulprits, sendToRecipient, "\${SCRIPT, template='path/to/script.groovy'}"
     }
}
// Override using configuration map, a little nicer way to invoke the function with named arguments
job('example'){
     publishers {
        CommonUtils.addExtendedEmail(delegate, emails:emails, triggers:['statusChanged'], attachmentPattern:".csv")
     }
}

// Override using configuration map, a little nicer way to invoke the function with named arguments
job('example'){
     publishers {
        CommonUtils.addExtendedEmail(delegate, emails:emails, triggers:['statusChanged'], attachmentPattern:".csv")
     }
}

// Override the default content and customize subject
job('example using configuration map'){
     publishers {
        CommonUtils.addExtendedEmail(delegate, emails:emails, content: "foo", subject: "bar")
     }
}
// Override using configuration map, a little nicer way to invoke the function with named arguments
job('example using configuration map') {
    publishers {
        CommonUtils.addExtendedEmail(emails: 'foo@example.com', triggers: ['statusChanged'], attachmentPattern: ".csv", delegate,)
    }
}
// Override the default content and customize subject
job('example') {
    publishers {
        CommonUtils.addExtendedEmail(emails: 'foo@example.com', content: "foo", subject: "bar", delegate)
    }
}


```

### Inject global passwords

```groovy
import jenkins.automation.builders.BaseJobBuilder
import jenkins.automation.utils.CommonUtils

new BaseJobBuilder(
        name: "sample-base-job-with-additional-config",
        description: "A job with some additional configurations added"
).build(this).with {
    CommonUtils.addInjectGlobalPasswords(delegate)
}
```

### Add shell parsing rules

```groovy
import jenkins.automation.builders.BaseJobBuilder
import jenkins.automation.utils.CommonUtils

new BaseJobBuilder(
        name: "sample-base-job-with-log-parsing",
        description: "A job with log parsing added"
).build(this).with {
    //how to use CommonUtils; pass a custom filename to override the default
    CommonUtils.addLogParserPublisher(delegate, "/var/lib/jenkins/some_rules_file.txt")
}
```

### Disable Concurrent Builds

```groovy
import jenkins.automation.builders.PipelineJobBuilder
import jenkins.automation.utils.CommonUtils

def script = """
    pipeline {
        agent { label 'master' }
        stages {
            stage('hello') {
                steps {
                    sh 'echo "Hello World"'
                }
            }
        }
    }
"""
new PipelineJobBuilder(
        name: 'pipeline-job-disables-concurrent-build',
        description: 'This is a simple pipeline job that disables concurrent builds',
        pipelineScript: script,
        sandboxFlag: false
).build(this).with {
    CommonUtils.disableConcurrentBuilds(delegate)
}
```

### Credentials Binding

```groovy
import jenkins.automation.builders.BaseJobBuilder
import jenkins.automation.utils.CommonUtils

new BaseJobBuilder(
    name: "sample-job-with-credentials-variable-bindings",
    description: "This is a job that uses our credentialsBinding helpers"
).build(this).with {
    //you can use one or the other or together if you need to
    CommonUtils.addUsernamePasswordCredentials(delegate, "some-credentials-id", "SOME-USERNAME-VAR", "SOME-PASSWORD-VAR")
    CommonUtils.addAmazonWebServicesCredentials(delegate, "some-aws-credentials-id", "SOME-ACCESS-KEY-VAR", "SOME-SECRET-KEY-VAR")
}
```

### Add virtualenv to a shell step

```groovy
import jenkins.automation.builders.BaseJobBuilder
import jenkins.automation.utils.CommonUtils

new BaseJobBuilder(
        name: "sample-base-job-with-virtualenv",
        description: "A job that creates and activates a python 2.7 virtualenv"
).build(this).with {
    steps {
        shell( CommonUtils.python27Virtualenv + """
                # pip install ansible
                ls -la
                env
                echo "Hello world"
            """.stripIndent()
        )
    }
}
```

### Add a performance publisher block

```groovy
import jenkins.automation.builders.BaseJobBuilder
import jenkins.automation.utils.CommonUtils

new BaseJobBuilder(
        name: "sample-base-job-with-performance-publisher",
        description: "A job with a performance publisher. It does not include the actual bits that run the load tests"
).build(this).with {
    steps {
        shell("echo 'Run jmeter tests here'")
    }
    CommonUtils.addPerformancePublisher(delegate,failedThresholdPositive=10, failedThresholdNegative=10, unstableThresholdPositive=5, unstableThresholdNegative=5)
}
```

## Plugin Utils

### New Relic

```
import jenkins.automation.builders.BaseJobBuilder

import jenkins.automation.utils.PluginUtils

def job=new BaseJobBuilder(
        name: "sample-base-job-with-new-relic",
        description: "A job with some additional plugin added"
).build(this).with {
        PluginUtils.addNewRelicSupport(delegate, "nr-api-key", "new", "foo", "some_log", "deploy", '1') //context, apiKey, applicationId, jobName, changeLog, user, revision

}
```

### SQS

```
import jenkins.automation.builders.BaseJobBuilder

import jenkins.automation.utils.PluginUtils

def job=new BaseJobBuilder(
        name: "sample-base-job-with-sqs-support",
        description: "A job with some additional plugin added"
).build(this).with {
    PluginUtils.addSQSNotification(delegate, "" ,"https://localhost/jenkins","foobar",customSQSMessageValue="Say something sharp" )
}
```

### Using a startup trigger

```groovy
import jenkins.automation.builders.BaseJobBuilder
import jenkins.automation.utils.PluginUtils

new BaseJobBuilder(
        name: "sample-base-job-with-startup-triggers",
        description: "A job with startup triggers"
).build(this).with {
    PluginUtils.startupTrigger(delegate)
}
```


### Using GH PR Watcher

This PR watcher can be used to help configure jobs for either GitHub.com
or a hosted GitHub Enterprise instance at a different hostname.

Create a job that builds pull requests for a specific repo in a
GitHub Enterprise instance. The `<unique GH PR builder credential ID>` should be
replaced with a credential ID created by the GitHub Pull Request Builder
itself. This can be found in the `config.xml` of a job already configured
to use the builder or from the `org.jenkinsci.plugins.ghprb.GhprbTrigger.xml`
in a Jenkins installation.

When running multiple PR Builder jobs on the same repo it's recommended to set
a unique `ghPrStatusContext` so that all results appear as individual checks
in the UI for the PR.

#### For GitHub Enterprise

```groovy
import jenkins.automation.builders.BaseJobBuilder
import jenkins.automation.utils.GhUtils

new BaseJobBuilder(
    name: 'GHE_PR_builder',
    description: 'Does GHE PR building from internal GHE',
).build(this).with {
    GhUtils.ghPrWatcher(
        delegate,
        [
            ghProject: 'cfpb/reponame',
            ghHostname: 'github.org.tld',
            ghAuthId: '<unique GH PR builder credential ID>',
            ghPrHooks: true,
            ghPrOrgsList: 'InternalDev',
            ghPrStatusContext: 'Test your example job',
            ghPrResultMessage: [
              'SUCCESS': 'Tests completed normally',
              'ERROR': 'Tests errored',
              'FAILURE': 'Tests failed',
            ]
        ]
    )

    steps {
        shell('''
        sh test.sh
        '''.stripIndent()
        )
    }
}
```

#### For GitHub.com

This job builder disables PRs from being built unless the creator is a member
of an organization in the orgs list, disables hooks since
public github can't talk back to your internal Jenkins, creates a cron,
and sets the orgs list so that anyone that belongs can automatically have
their PR built. Any organization member can also simply comment 'ok to test'
on a PR from a user outside of the organization to have that PR built
with Jenkins.

```groovy
import jenkins.automation.builders.BaseJobBuilder
import jenkins.automation.utils.GhUtils

new BaseJobBuilder(
    name: 'GH_PR_builder',
    description: 'PR build from GitHub.com',
).build(this).with {
    GhUtils.ghPrWatcher(
        delegate,
        [
            ghProject: 'cfpb/reponame',
            ghHostname: 'github.com',
            ghAuthId: '<unique GH PR builder credential ID>',
            ghPrHooks: false,
            ghPrCron: '*/2 * * * *',
            ghPrOrgsList: 'CFPB',
            ghPrStatusContext: 'Test your example job',
            ghPrResultMessage: [
              'SUCCESS': 'Tests completed normally',
              'ERROR': 'Tests errored',
              'FAILURE': 'Tests failed',
            ]
        ]
    )

    steps {
        shell('''
        sh test.sh
        '''.stripIndent()
        )
    }
}
```
